# Changelog

## v2.5.1 (2025-12-26)

### 🎨 UI/UX 重大改进

#### 封面生成界面重新设计
- **全新视觉风格**：完全重构 Covers.tsx，采用现代化 MP-Plugin 风格设计
- **大尺寸预览卡片**：风格选择从小卡片改为大型可视化预览卡片（3列布局）
  - 每个风格卡片显示大型预览图（aspect-[2/3]）
  - 选中状态带蓝色光环效果 (ring-4 ring-blue-500)
  - "已选择"徽章标签提示
  - 悬停时阴影增强效果
  
- **精美渐变卡片设计**：
  - 单图设置：蓝紫渐变背景 (from-blue-50 to-purple-50)
  - 多图设置：紫粉渐变背景 (from-purple-50 to-pink-50)
  - 动画设置：黄橙渐变背景 (from-yellow-50 to-orange-50)
  - 生成动画：绿青渐变背景 (from-green-50 to-teal-50)

- **增强的滑块控件**：
  - 带实时数值显示的大号标签
  - 彩色进度条（根据当前值动态渲染渐变）
  - 清晰的最小/最大值文本说明
  - 更直观的交互反馈

- **改进的复选框设计**：
  - 更大的复选框尺寸 (w-6 h-6)
  - 双行标签（标题+描述）
  - 图标化的视觉引导

- **顶部标题栏优化**：
  - 大号渐变图标徽章 (w-14 h-14)
  - 渐变文字标题效果 (bg-clip-text text-transparent)
  - 简洁的副标题说明

- **操作按钮升级**：
  - 大号渐变按钮 (px-8 py-4, text-lg)
  - 图标动画效果 (group-hover:scale-110)
  - 更明显的加载状态指示
  - 禁用状态的视觉优化

- **预览区域美化**：
  - 大图居中展示，带阴影和光环效果
  - 悬停时显示下载按钮遮罩
  - 圆角和边框优化

- **错误提示重设计**：
  - 红色渐变警告卡片
  - 图标化的错误提示
  - 可关闭的错误消息

#### 标签页导航改进
- 移除"高级选项"标签页，保留核心功能：
  - 封面风格
  - 单图设置
  - 多图设置
  - 动画设置
- 每个标签带图标和彩色活动指示器
- 更流畅的标签切换动画

#### 状态管理优化
- 新增 `uploading` 状态，区分生成和上传过程
- 新增 `generatedImage` 状态，替代 `previewUrl`
- 新增 `error` 状态，统一错误处理
- 移除未使用的 `handleDownload` 函数

---

## v2.5 (2025-12-26)

### 🎨 重磅新功能：媒体库封面生成系统

#### 核心功能
- **封面生成页面** - 全新的"封面"标签页，采用MP-Plugin风格5标签页界面
  - 为 Emby 媒体库自动生成精美的自定义封面
  - 整合 jellyfin-library-poster 和 MoviePilot-Plugins 的精华功能
  - 支持静态图片和动画封面两种模式

#### 三种封面风格
- **单图风格1 (single_1)**：单张海报 + 模糊背景
- **单图风格2 (single_2)**：单张海报 + 颜色混合背景  
- **多图风格 (multi_1)**：3×3 海报阵列，旋转排列，渐变背景

#### 动画封面支持 ✨
- **GIF格式**：经典动画格式，兼容性最好
- **WebP格式**：现代格式，文件更小，质量更高
- **帧数控制**：15-60帧可调，平衡生成速度与流畅度
- **帧间隔设置**：30-100ms可调，控制播放速度
- **无缝循环**：采用扩展列技术，实现完美循环动画
- **滚动效果**：3列海报垂直滚动，配合轻微旋转动画

#### 智能配色系统
- 自动提取海报主色调（最多5种颜色）
- 马卡龙色系调整（HSV 色彩空间，S: 0.3-0.7, V: 0.6-0.85）
- 过滤黑白灰色，确保背景色彩鲜明
- 左深右浅的渐变背景效果
- 颜色距离算法避免相似色

#### 5标签页配置界面（MP-Plugin风格）
1. **风格选择**：卡片式风格选择器，带预览图和选中状态
2. **单图设置**：模糊半径(5-50)、颜色混合比例(0-100%)、胶片颗粒开关
3. **多图设置**：海报数量(4-16)、模糊效果、马卡龙配色、颗粒效果
4. **动画设置**：动画开关、帧数(15-60)、帧间隔(30-100ms)、GIF/WebP格式选择
5. **高级选项**：标题字体比例(8-20%)、日期字体比例(3-10%)

#### 完整的操作流程
- ✅ 选择媒体库
- ✅ 配置封面参数（5个标签页）
- ✅ 实时预览生成效果
- ✅ 一键下载封面到本地（支持PNG/GIF/WebP）
- ✅ 一键上传封面到Emby服务器

#### 特效与增强
- **胶片颗粒效果**：使用numpy添加真实的胶片质感
- **阴影效果**：海报添加立体阴影
- **图片旋转**：多图风格支持旋转角度调整
- **模糊处理**：高斯模糊背景
- **渐变背景**：HSL色彩空间渐变

### 技术实现

#### 后端服务
- 新增 `backend/services/cover_generator.py`（879行）
  - `generate_style_multi()`: 多图拼贴风格
  - `generate_style_single()`: 单图马卡龙风格  
  - `generate_animated_cover()`: 动画封面生成
  - `create_extended_column()`: 创建无缝循环列
  - `generate_animation_frame()`: 单帧渲染
  - `find_dominant_macaron_colors()`: 马卡龙色提取
  - `create_gradient_background()`: 渐变背景生成

#### API接口
- 新增 `backend/routers/cover.py`
  - `GET /api/cover/libraries`: 获取媒体库列表
  - `POST /api/cover/generate`: 生成封面（支持静态/动画）
  - `POST /api/cover/upload/{library_id}`: 上传封面到Emby
  - `GET /api/cover/preview/{library_id}`: 预览媒体库项目

#### 前端组件
- 新增 `frontend/src/pages/Covers.tsx`（595行）
  - 5标签页界面（风格/单图/多图/动画/高级）
  - 卡片式风格选择器
  - 滑块和复选框参数控件
  - 实时预览和下载功能
  - TypeScript完整类型定义

#### Emby集成
- 新增 `emby_service.upload_library_image()`
  - 调用Emby API上传图片
  - 支持Primary/Backdrop/Logo等类型
  - 超时处理（60秒）

### 依赖更新
- **后端**：新增 `numpy==1.24.3` 用于胶片颗粒效果
- **前端**：已有 `lucide-react` 用于图标

### 文档完善
- 新增 `docs/COVER_GENERATION.md` - 详细功能文档
- 新增 `docs/COVER_QUICKSTART.md` - 快速开始指南
- 新增 `docs/COVER_INTEGRATION_SUMMARY.md` - 集成总结
- 更新 `README.md` - 添加封面生成功能说明

### 界面优化
- 导航栏新增"封面"标签（Image图标）
- 采用Tailwind CSS 4.x样式
- 响应式布局适配
- 加载状态提示（Loader2动画）

---

## v2.0 (2025-12-10)

---

## v1.9 (2025-12-10)

### 新功能
- **收藏页面重构** - 全新的双视图收藏展示
  - **按用户视图**：展示每个用户的收藏列表，支持展开查看完整收藏
  - **热门榜单视图**：保留原有的收藏排行榜功能
  - **用户搜索**：快速搜索特定用户的收藏
  - **类型筛选**：支持按全部/电影/剧集筛选
  - 用户卡片显示收藏数量和海报预览

---

## v1.85 (2025-12-10)

### 修复
- **服务器编辑数据丢失问题** - 修复编辑服务器配置时数据库路径被清空的问题
  - 编辑服务器时只更新实际修改的字段，不再覆盖未修改的配置

---

## v1.84 (2025-12-10)

### 新功能
- **绑定用户搜索** - 在绑定用户列表中添加搜索功能
  - 支持按 Emby 用户名、Telegram 用户名、Telegram 昵称、Telegram ID 搜索
  - 快速定位特定绑定用户

---

## v1.80 (2025-12-10)

### 新功能
- **Telegram 用户绑定** - 支持 Emby 用户绑定 Telegram 账号，接收个人观影报告
  - 用户通过 Bot 发送 `/bind` 命令，输入 Emby 账号密码完成绑定
  - 绑定后自动接收个人专属的每日/每周/每月观影报告
  - 支持解绑操作

### 改进
- **Docker 日志限制** - 添加容器日志大小限制，防止日志文件过大

---

## v1.71 (2025-12-08)

### 修复
- **登录页面服务器列表问题** - 修复未登录时无法获取服务器列表的问题
  - 服务器 API 被认证中间件拦截，导致登录页面显示"未配置服务器"
  - 将 `/api/servers` 添加到公开路径，允许未认证访问

---

## v1.7 (2025-12-08)

### 新功能
- **多服务器支持** - 支持管理多个 Emby 服务器
  - 在 Web 界面添加、编辑、删除服务器配置
  - 登录时可选择要连接的服务器
  - 支持设置默认服务器
  - 旧版环境变量配置自动迁移
- **文件选择器** - 添加服务器时可通过文件浏览器选择数据库路径
  - 浏览容器内文件系统
  - 支持快捷路径跳转
  - 直接选择 .db 数据库文件

### 改进
- **界面优化** - 调整面板背景透明度，提升文字可读性

---

## v1.6 (2025-12-07)

### 改进
- **动画与UI优化** - 优化了一些动画效果与UI微调

---

## v1.57 (2025-12-06)

### 新功能
- **Telegram 代理支持** - 支持在 Web 界面配置 Telegram 推送代理
  - 支持 HTTP 代理（如 `http://127.0.0.1:7890`）
  - 支持 SOCKS5 代理（如 `socks5://127.0.0.1:1080`）
  - 在「观影报告」设置页面可直接配置

---

## v1.51 (2025-12-04)

### 改进
- **UI 优化** - 界面样式调整与改进

---

## v1.5 (2025-12-04)

### 新功能
- **观影报告推送** - 支持通过 Telegram Bot 推送观影报告
  - 三个独立定时任务：每日报告、每周报告、每月报告
  - 每个任务可单独启用/禁用，自定义 Cron 表达式
  - 支持手动触发发送，可选择发送哪个周期的报告
  - 报告内容包含：观看时长、播放次数、观看内容数、热门内容排行
  - 美化的报告图片：现代深色主题、渐变背景、海报阴影、排名颜色

### 改进
- **内容统计去重** - 观看内容数量现在按 ItemId 去重，同一集播放多次只算1个内容
- **时间范围过滤** - 报告数据严格按照时间范围过滤（今日/本周/本月）

---

## v1.4 (2025-12-04)

### 新功能
- **历史记录搜索** - 支持按内容名称搜索播放历史
  - 搜索时自动使用全库范围，不受时间筛选限制
  - 搜索结果以列表形式展示（封面 + 内容名称 + 用户 + 时间 + 播放时长 + 客户端 + 设备）
  - 正常浏览时仍使用海报网格展示
  - 搜索同样遵循 `MIN_PLAY_DURATION` 环境变量的过滤规则

---

## v1.3 (2025-12-03)

### 新功能
- **Web 界面名称映射配置** - 可直接在设置面板中配置客户端/设备名称映射
- **设置面板** - 右上角新增设置按钮，支持在线配置

### 改进
- 名称映射配置自动保存到 `/config/name_mappings.json`

---

## v1.2 (2025-12-02)

### 新功能
- **MIN_PLAY_DURATION 环境变量** - 支持过滤播放时长过短的记录
- **播放时长过滤** - 低于设定时长的记录不计入历史和统计

---

## v1.1 (2025-12-01)

### 新功能
- **名称映射** - 支持通过配置文件自定义客户端/设备显示名称
- **PWA 支持** - 可添加到手机主屏幕作为独立应用

---

## v1.0 (2025-11-30)

### 初始版本
- 实时播放监控
- 播放趋势分析
- 热门内容排行
- 用户统计
- 设备/客户端统计
- 播放历史记录
- 管理员认证登录
