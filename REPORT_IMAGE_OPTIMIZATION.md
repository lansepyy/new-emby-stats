# 报告图片生成优化说明

## 📋 改进内容

基于 MP 插件的精美设计，对报告图片生成进行了全面优化，同时保持竖版布局。

### 主要改进

#### 1. 🎨 视觉效果增强

- **文字描边效果**: 所有重要文字添加黑色描边，类似 MP 插件的 PSD 风格，大幅提升可读性
- **背景图片支持**: 支持使用精美背景图片，自动调整大小、裁剪并添加半透明遮罩
- **圆角封面**: 封面图片添加圆角效果，更加美观
- **占位符优化**: 无封面时显示美观的占位符

#### 2. 📐 尺寸优化

- **宽度调整**: 从 1200px 改为 1080px，与前端手动推送保持一致
- **封面尺寸增大**: 从 90×120 增大到 110×155（接近 MP 的 108×159）
- **卡片高度增加**: 统计卡片和内容卡片高度增加，布局更舒适
- **间距优化**: 各元素间距调整，视觉更协调

#### 3. 🎯 细节优化

- **字体系统**: 优先使用资源目录中的字体，支持自定义字体
- **颜色调整**: 次要文字颜色改为 #9ca3af，与前端完全一致
- **页脚文案**: 改为 "New Emby Stats" 与前端保持一致
- **文字截断**: 优化标题截断长度（从24改为20字符）

#### 4. 🔧 代码优化

- **资源管理**: 统一的资源目录管理（res/）
- **错误处理**: 完善的异常处理和日志记录
- **模块化设计**: 添加独立的辅助方法（描边、圆角、占位符等）

## 📂 目录结构

```
emby-stats/
├── res/                          # 资源目录（新增）
│   ├── bg/                       # 背景图片目录
│   │   ├── bg1.jpg              # 背景图片（从 MP 复制）
│   │   ├── bg2.png
│   │   └── ...
│   ├── PingFang Bold.ttf        # 字体文件（从 MP 复制）
│   └── README.md                # 资源说明
├── backend/
│   └── services/
│       └── report_image.py      # 优化后的图片生成服务
└── test_report_generation.py    # 测试脚本（新增）
```

## 🚀 使用方法

### 1. 添加资源文件（可选但推荐）

从 MP 插件复制资源文件以获得最佳效果：

```bash
# 复制背景图片
cp -r /path/to/mp/res/bg/*.{jpg,png} res/bg/

# 复制字体文件
cp /path/to/mp/res/"PingFang Bold.ttf" res/
```

### 2. 测试生成效果

运行测试脚本查看效果：

```bash
python test_report_generation.py
```

生成的测试图片会保存为 `test_report.png`。

### 3. 正常使用

- **定时推送**: 自动使用新的生成逻辑
- **手动推送**: 前端界面手动发送时使用浏览器截图（保持不变）

## 🎨 效果对比

### 优化前
- ❌ 文字无描边，在背景上可能看不清
- ❌ 封面较小（90×120）
- ❌ 纯色背景，略显单调
- ❌ 宽度 1200px，与前端不一致

### 优化后
- ✅ 所有重要文字添加黑色描边，清晰易读
- ✅ 封面增大到 110×155，更加醒目
- ✅ 支持精美背景图片（可选）
- ✅ 宽度 1080px，与前端完全一致
- ✅ 圆角封面、优化的占位符
- ✅ 更大的卡片和更合理的间距

## 📝 关键改进点

### 1. 文字描边实现

```python
def _draw_text_with_stroke(self, draw, xy, text, font, fill, stroke_color, stroke_width):
    """绘制带描边的文字 - 参考 MP 插件的 PSD 风格"""
    x, y = xy
    # 8个方向绘制描边
    for offset_x in range(-stroke_width, stroke_width + 1):
        for offset_y in range(-stroke_width, stroke_width + 1):
            if offset_x != 0 or offset_y != 0:
                draw.text((x + offset_x, y + offset_y), text, font=font, fill=stroke_color)
    # 绘制主文字
    draw.text(xy, text, font=font, fill=fill)
```

### 2. 背景图片处理

```python
def _create_background(self, height):
    """创建背景 - 支持背景图或纯色"""
    # 随机选择背景图
    # 自动缩放和裁剪
    # 添加半透明遮罩（保证文字清晰）
    # 回退到纯色背景
```

### 3. 圆角封面

```python
def _add_rounded_corners(self, img, radius):
    """为图片添加圆角"""
    # 创建圆角遮罩
    # 应用到封面图片
```

## 🔍 技术细节

- **图片格式**: PNG（高质量，compress_level=1）
- **分辨率**: 1080px 宽，动态高度
- **字体优先级**: 
  1. res/ 目录中的字体文件
  2. 系统中文字体（微软雅黑、思源黑体等）
  3. 默认字体（fallback）

## 📊 性能

- 生成时间: ~1-3秒（取决于内容数量和是否有背景图）
- 文件大小: ~100-500KB（PNG 格式）
- 内存占用: 合理（及时释放资源）

## 🎯 兼容性

- ✅ 保持与前端手动推送的一致性
- ✅ 向后兼容（无资源文件时使用纯色背景和系统字体）
- ✅ 支持 Windows、Linux、macOS
- ✅ Docker 环境友好

## 📌 注意事项

1. **资源文件**: 虽然是可选的，但强烈推荐添加以获得最佳效果
2. **字体文件**: 如果在 Docker 中使用，确保字体文件打包到镜像中
3. **背景图片**: 建议使用高分辨率图片（至少 1080×1500）
4. **性能**: 首次生成可能较慢（加载字体和背景），后续会更快

## 🚀 后续优化建议

1. **缓存机制**: 缓存字体和背景图片加载
2. **主题支持**: 支持亮色/暗色主题切换
3. **模板系统**: 支持多种报告模板
4. **动态配置**: 允许用户自定义颜色、字体大小等

## 📖 参考

- MP 插件报告生成逻辑
- Pillow 图像处理库文档
- 前端 ReportImage 组件设计
